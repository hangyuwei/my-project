# 云开发模板集成说明

## 已集成的云开发模板

本项目已集成以下腾讯云开发模板：

### 1. wx-user-v2 用户信息管理模板

**功能**：自动管理用户信息，包括 openid、unionid、用户基本资料等。

**使用的云函数**：
- `tcb-user-info`: 获取用户基本信息

**集成位置**：
- `app.js` 的 `getOpenid()` 方法

**工作流程**：
1. 小程序启动时，自动调用 `tcb-user-info` 云函数获取用户信息
2. 如果云函数不存在或调用失败，会自动降级到原有的 `login` 云函数
3. 用户信息存储在 `app.globalData.userInfo` 中

### 2. wx-pay-v2 微信支付模板

**功能**：提供完整的微信支付流程，包括统一下单、支付结果查询等。

**使用的云函数**：
- `tcb-pay-unified-order`: 微信统一下单接口

**集成位置**：
- `pages/order/order-confirm/pay.js` 的 `wechatPayOrder()` 方法

**工作流程**：
1. 用户在订单确认页点击"提交订单"
2. 调用 `tcb-pay-unified-order` 云函数创建微信支付订单
3. 获取支付参数后调用 `wx.requestPayment()` 拉起微信支付
4. 支付成功后跳转到支付结果页面
5. 如果云函数不存在或调用失败，会自动降级到模拟支付（直接标记为支付成功）

---

## 如何验证集成是否成功

### 验证用户信息管理

1. 打开微信开发者工具的控制台
2. 启动小程序
3. 查看控制台日志，应该看到以下信息：
   ```
   [wx-user-v2] 获取用户信息成功: {...}
   ```
4. 如果看到降级提示，说明 `tcb-user-info` 云函数未安装或配置错误：
   ```
   [wx-user-v2] 云函数调用失败，降级使用原有登录方式: {...}
   ```

### 验证微信支付

1. 在小程序中添加商品到购物车
2. 进入订单确认页面
3. 点击"提交订单"按钮
4. 查看控制台日志，应该看到以下信息：
   ```
   [wx-pay-v2] 开始调用统一下单 {...}
   [wx-pay-v2] 统一下单成功: {...}
   ```
5. 如果支付云函数未安装，会看到降级提示并直接模拟支付成功：
   ```
   [wx-pay-v2] 云函数调用失败，降级为模拟支付: {...}
   ```

---

## 重要提示

### 关于降级机制

为了保证小程序的可用性，代码中添加了降级机制：

1. **用户信息降级**：如果 `tcb-user-info` 不可用，会使用原有的 `login` 云函数
2. **支付降级**：如果 `tcb-pay-unified-order` 不可用，会直接模拟支付成功

这意味着即使云开发模板未正确安装，小程序仍然可以正常运行。

### 云函数配置

如果你已经在云开发控制台安装了模板，但仍然无法调用，请检查：

1. 云函数是否已部署到正确的环境
2. 小程序的云开发环境 ID 是否正确（查看 `config/index.js` 中的 `cloudEnvId`）
3. 支付模板需要配置微信支付商户号等信息

### 支付模板额外配置

wx-pay-v2 模板需要配置以下信息才能正常工作：

1. 微信支付商户号（mchid）
2. 商户 API 密钥（key）
3. 商户证书

这些信息需要在云开发控制台的模板设置中配置。

---

## 测试建议

### 开发阶段

在开发阶段，建议先使用降级模式测试功能逻辑，确保订单流程正常后再配置真实支付。

### 生产阶段

上线前务必：

1. 确认 `tcb-user-info` 云函数可以正常调用
2. 确认 `tcb-pay-unified-order` 云函数已配置商户信息
3. 使用沙箱环境测试支付流程
4. 验证支付成功后订单状态更新正确

---

## 常见问题

### Q: 云函数调用失败怎么办？

**A**: 检查以下几点：
1. 云函数是否已在云开发控制台部署
2. 云函数名称是否正确（`tcb-user-info` 和 `tcb-pay-unified-order`）
3. 小程序的云开发环境 ID 是否配置正确

### Q: 支付时提示参数错误？

**A**: 检查以下几点：
1. 订单金额是否正确（会自动转换为分）
2. 商户号是否已配置
3. 查看云函数日志排查具体错误信息

### Q: 如何查看云函数日志？

**A**:
1. 登录腾讯云开发控制台
2. 进入"云函数"页面
3. 点击对应的云函数
4. 查看"日志"选项卡

---

## 技术支持

如果遇到问题，可以：

1. 查看腾讯云开发文档：https://cloud.tencent.com/document/product/876
2. 查看云开发模板使用说明
3. 检查控制台日志中的详细错误信息
